var ChatClient,Identity,IPM_Channel,Transferred,SessionId=$.cookie("_sa"),BaseUrl="https://comms-api.scorpion.co",today=(new Date).getDay(),IPM_QueueMessages=[];rrequire(["jquery","static","uri","cookie","m/date","https://media.twiliocdn.com/sdk/js/client/v1.5/twilio.min.js","https://media.twiliocdn.com/sdk/js/chat/v3.2/twilio-chat.min.js"],function(t,e){var a,n=null,s=null,i=null,o=null,c=e.CMS||{},r=c.Chat||{},l={Domain:document.domain,Referrer:document.referrer,SPPC:null,IPAddress:null,UserAgent:navigator.userAgent};if(t.ajax({url:"https://api.ipify.org/?format=json",error:function(){l.IpAddress=null}}).done(function(t){l.IpAddress=t.ip}),Modernizr.websockets){e.CMS||(e.CMS=c),c.Chat||(c.Chat=r),c.Chat.checkPageType=function(){var t;t=navigator.userAgent||navigator.vendor||window.opera,/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4))?c.Chat.setState("pageType","Mobile"):c.Chat.setState("pageType","Desktop")},r.init=function(){c.Chat.checkPageType(),t("head").append('<link rel="stylesheet" type="text/css" href="https://cdn.cxc.scorpion.direct/chat-v3.css">'),n=t(a),s=n.find("textarea"),i=n.find("ul"),t("body").find("#ScorpionConnect")&&t("body").append(n);var e=c.Chat.getState().businessName;e.substring(0,30)!==e?t(n).find(".businessName").html(e.substring(0,28)+"..."):t(n).find(".businessName").html(e),t("#ScorpionConnect").hide(),n.addClass("cms-connect"),n.find(".agent-image").css("background-image","url("+c.Chat.getState().agentImage+")");var l=c.Chat.getState().customLogoPath;switch(l>""&&(n.addClass("cms-busi-logo"),t(".cms-connect-header").find(".logo").css("background-image","url("+l+")")),"True"==c.Chat.getState().noStaffImage&&n.addClass("no-staff-image"),c.Chat.getState().placementTypeID){case 1:n.addClass("cms-layout-br");break;case 2:n.addClass("cms-layout-bl");break;case 3:n.addClass("cms-layout-cr");break;default:n.addClass("cms-layout-br")}var d=null==c.Chat.getState().p_color?"light":c.Chat.getState().p_color,h=!1;switch(d.substring(0,1)){case"l":n.addClass("cms-theme-light");break;case"d":n.addClass("cms-theme-dark");break;case"#":n.addClass("cms-theme-inherit"),h=!0;break;default:n.addClass("cms-theme-light")}if(1==h){var m=".cms-connect.cms-theme-inherit .cms-agent > .cms-profile {\t\t\t\t\t\tbackground-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect.cms-theme-inherit .cms-agent:before {\t\t\t\t\t\tborder-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect.cms-theme-inherit .cms-agent .cms-message-toast {\t\t\t\t\t\tbackground-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect.cms-theme-inherit .cms-connect-header {\t\t\t\t\t\tbackground-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect.cms-theme-inherit .cms-connect-scroll li.user {\t\t\t\t\t\tbackground-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect.cms-theme-inherit .cms-connect-scroll li.user:before {\t\t\t\t\t\tbackground-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect.cms-theme-inherit .cms-connect-chat textarea:focus {\t\t\t\t\t\tborder-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect.cms-theme-inherit .cms-connect-chat a {\t\t\t\t\t\tbackground-color: {replace};\t\t\t\t\t}\t\t\t\t\t.cms-connect .chat-history li .type-load span:before {\t\t\t\t\t\tbackground-color: {replace} !important\t\t\t\t\t}";m=m.replace(new RegExp("{replace}","g"),d),t("<style type='text/css'>"+m+"</style>").appendTo("head")}var p=c.Chat.getState().bump,g=c.Chat.getState().bumpMessage,u=c.Chat.getState().smsDisplay,C=/\S/.test(u)?u:"Text Us Now";"True"==p&&g>""&&(n.find(".cms-message-toast").attr("data-message",g),"Mobile"==c.Chat.getState().pageType&&n.find(".cms-message-toast").attr("data-message",C),setTimeout(function(){n.addClass("cms-bump")},5e3)),c.Chat.getPhoneFromCookie=function(){var t=document.cookie.split("; "),e=[],a=[];for(n=0;n<t.length;n++)e.push(t[n].split("="));for(var n in e)a[e[n][0]]=e[n][1];return a.PPCP1?phone=a.PPCP1:a.PPCP2?phone=a.PPCP2:a.SubPhone?phone=a.SubPhone:phone=c.Chat.getState().cidnum,phone},t(".cms-connect").on("click",function(e){var a=Get.LinkData(e);switch(a.action){case"Minimize":n.removeClass("expand"),n.removeClass("cms-bump"),r.minimize();break;case"Maximize":"Desktop"==c.Chat.getState().pageType&&(n.addClass("expand"),void 0===n.find(".system-notification").html()&&c.Chat.printMessage(c.Chat.getState().introMessage,"System"));break;case"Close":return void r.minimize();case"Destroy":return void(1==confirm("Are you sure you want to end your chat session?")&&(c.Chat.setState("minimize",!0),n.removeClass("expand"),r.destroy(!0)));case"XOut":return void r.destroy(!0);default:return"Desktop"==c.Chat.getState().pageType&&(0===i[0].children.length&&c.Chat.printMessage(c.Chat.getState().introMessage,"System"),n.hasClass("expand")||(n.addClass("expand"),c.Chat.setState("minimize",!1))),void("Mobile"==c.Chat.getState().pageType&&(t(".cms-connect-sms-click-text")[0].click(),n.hide()))}}).find("a").on("dragstart",function(t){return!1}),o=n.find("a.chat-start"),n.on("click",function(t){switch(Get.LinkData(t.originalEvent).action){case"Close":_active=!1,n.remove();break;case"Send":s.val()>""&&r.send(null)}}),s.on("keydown",function(t){if(13==t.which&&!t.shiftKey)return s.val()>""&&r.send(null),StopAll(t);void 0!==IPM_Channel&&IPM_Channel.typing()}),setTimeout(function(){t("#ScorpionConnect").show()},1e3)},r.loadingBubbles=function(e){e?t('<div class="loader"><div></div><div></div><div></div><div></div></div>').appendTo(i).scrollIntoView(100,8):i.find(".loader").remove()},r.start=function(){r.loadingBubbles(!0),t.ajax({method:"POST",url:BaseUrl+"/CX/Chat/Init",data:{SessionID:SessionId,ClientID:c.Chat.getState().clientID,ProjectID:c.Chat.getState().projectID,Name:"Anonymous User",Email:"n/a",AgentName:c.Chat.getState().agentName,AgentImage:c.Chat.getState().agentImage,BusinessName:c.Chat.getState().businessName,ScorpionInternal:!1,Domain:l.Domain,Referrer:l.Referrer,IpAddress:l.IPAddress,UserAgent:l.UserAgent}}).done(function(t){t.ChatToken?(c.Chat.setState("ChatToken",t.ChatToken),c.Chat.setState("ChannelSid",t.ChannelSid),c.Chat.setState("Identity",t.GuestIdentity),Twilio.Chat.Client.create(t.ChatToken).then(function(e){ChatClient=e,ChatClient=e.getSubscribedChannels().then(C(e,t.ChannelSid))})):(c.Chat.setState("ChannelSid",t.ChannelSid),c.Chat.setState("Identity",t.GuestIdentity),r.getToken(t.GuestIdentity,t.ChannelSid))})},r.getToken=function(e,a){t.ajax({method:"POST",url:BaseUrl+"/CX/Chat/Token",data:{Identity:e}}).done(function(t){c.Chat.setState("ChatToken",t.ChatToken),Twilio.Chat.Client.create(t.ChatToken).then(function(t){ChatClient=t,ChatClient=t.getSubscribedChannels().then(C(t,a))})})},r.recover=function(){var e=t.cookie("SEOV"),a=t.cookie("SEOT"),s=c.Chat.getState().pt,i=c.Chat.getState().pv;1==c.Chat.getState().started||1==function(t,e,a,n){if(!0!==c.Chat.getState().minimize){var s=t?parseInt(t):0,i=e?parseInt(e):0;return a>0&&n>0&&(a<=s||n<=i)}return!1}(a,e,s,i)?(n.addClass("expand"),r.printMessage(c.Chat.getState().proactiveMessage,"System")):1==c.Chat.getState().minimize&&n.removeClass("expand"),!ChatClient&&c.Chat.getState().ChatToken&&(ChatClient=Twilio.Chat.Client.create(c.Chat.getState().ChatToken).then(function(t){return ChatClient=t,ChatClient=t.getSubscribedChannels().then(C(t,c.Chat.getState().ChannelSid)),t}))},r.destroy=function(t){t&&(i.empty(),n.hide(),IPM_Channel.members.size>1&&IPM_Channel.sendMessage("clientmetadata:close-task")),Transferred=!0,c.Chat.setState("started",!1),c.Chat.setState("ChannelSid",""),c.Chat.setState("ChatToken",void 0),IPM_Channel=void 0},r.updateTypingIndicator=function(e){if(e){var a=t(_htmlTyping);a.find("p"),a.appendTo(i).scrollIntoView(100,8)}else i.find(".is-typing").remove()},r.minimize=function(){n.removeClass("expand"),c.Chat.setState("minimize",!0)},r.send=function(t){var e=t>""?t:s.val();void 0!==IPM_Channel?IPM_Channel.sendMessage(e.trim()):null==IPM_Channel&&(c.Chat.start(),IPM_QueueMessages.push(e)),t||s.val("").trigger("input")},r.printMessage=function(e,a){if(!e||"clientmetadata:"==e.substring(0,15))return null;if("Guest"==a)template=_htmlMe;else if("System"==a)template=_htmlSystem;else{new Audio("https://cdn.cxc.scorpion.direct/ChatNotificationAudio.wav").play(),template=_htmlThem,n.hasClass("expand")||(n.find(".cms-message-toast").attr("data-message",e),n.addClass("cms-bump"))}var s=t(template);a&&(o.addClass("chatting"),o[0].childNodes[0].style.backgroundImage="url('"+function(t){return"System"!==t||"Guest"!==t?c.Chat.getState().agentImage:""}(a)+"')"),e=e.replace(/_/g,"&lowbar;").replace(/<[^>]+>/g," ").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n/g,"<br>").replace(/(\*{1,3}|~|_)([^\*]+)\1/g,function(t,e,a){switch(e){case"*":return"<em>"+a+"</em>";case"**":return"<strong>"+a+"</strong>";case"***":return"<strong><em>"+a+"</em></strong>";case"~":return"<strike>"+a+"</strike>"}}).replace(/\bhttps?:\/\/\S+/g,function(t){return'<a href="'+t+'" target="_blank">'+t+"</a>"}),s.find("p").attr("data-timestamp",(new Date).formatted("h:mmtt").toLowerCase()).html(e),s.appendTo(i).scrollIntoView(100,8),r.updateTypingIndicator(!1)},t(document).on("focus",".cms-connect-chat",function(){t("#ScorpionConnect").addClass("cms-chatting"),t("#ScorpionConnect").addClass("cms-conversion")}),t(document).on("blur",".cms-connect-chat",function(){t("#ScorpionConnect").removeClass("cms-chatting"),t("#ScorpionConnect").removeClass("cms-conversion")}),a='\t\t\t<div icobalt="" id="ScorpionConnect" class="">\t\t\t\t<div class="cms-connect-portal">\t\t\t\t\t<header class="cms-connect-header">\t\t\t\t\t\t<a href="javascript:void(\'Minimize\')" class="minimize"><img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" width="0" height="0" alt="Minimize Chat"/></a>\t\t\t\t\t\t<a href="javascript:void(\'Destroy\')" class="end"><img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" width="0" height="0" alt="Close Chat"/></a>\t\t\t\t\t\t<img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="logo" alt="Business Logo" >\t\t\t\t\t</header>\t\t\t\t\t<div class="cms-connect-scroll chat-history">\t\t\t\t\t\t<ul></ul>\t\t\t\t\t</div>\t\t\t\t\t<div class="cms-connect-chat">\t\t\t\t\t\t<textarea id="cms-connect-chat-input" placeholder="Type your response here"></textarea>\t\t\t\t\t\t<a href="javascript:void(\'Send\')"><img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" width="0" height="0" alt="Send Message"/>Send Message</a>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="cms-agent" data-notification="1">\t\t\t\t\t<div class="cms-message-toast" data-message="Hi, how can I help you?" data-agent="">\t\t\t\t\t\t<a href="javascript:void(\'XOut\')" class="close"><img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" width="0" height="0" alt="Close Chat"/></a>\t\t\t\t\t</div>\t\t\t\t\t<div class="cms-profile">\t\t\t\t\t\t<a href="javascript:void(\'Start\');" class="chat-start" role="button"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="agent-image" alt="Open Chat"/></a>\t\t\t\t\t</div>\t\t\t\t\t<span class="businessName"></span>\t\t\t\t</div>\t\t\t</div>',_htmlMe='\t\t\t<li class="user"><p></p></li>',_htmlThem='\t\t\t<li class="agent"><p></p></li>',_htmlSystem='\t\t\t<li class="system-notification"><p></p></li>',_htmlTyping='\t\t\t<li class="agent is-typing">\t\t\t\t<p>\t\t\t\t\t<span class="type-load"><span></span><span></span><span></span></span>\t\t\t\t</p>\t\t\t</li>';var d=null;if(c.Chat.getState=function(){var t;if(!d)if(t=localStorage.chatData)try{d=JSON.parse(t)||{}}catch(t){d={}}else d={};return d},c.Chat.setState=function(t,e){var a=c.Chat.getState();a[t]=e,localStorage.chatData=JSON.stringify(a)},!0===c.Chat.getState().started)"Desktop"==c.Chat.getState().pageType&&(c.Chat.init(),c.Chat.recover());else{var h,m=t("html").data("sa"),p=t("body").data("location"),g=t.cookie("L");function u(e){c.Chat.setState("data",e),c.Chat.setState("sta",e.s),c.Chat.setState("end",e.e),c.Chat.setState("scorpionInternal",e.i),c.Chat.setState("clientID",e.c),c.Chat.setState("projectID",e.p),c.Chat.setState("introMessage",e.im),c.Chat.setState("proactiveMessage",e.pm),c.Chat.setState("pt",e.pt),c.Chat.setState("pv",e.pv),c.Chat.setState("ps",e.pv),c.Chat.setState("cidnum",e.cidnum),c.Chat.setState("agentName",e.an),c.Chat.setState("agentImage",e.ai),c.Chat.setState("noStaffImage",e.nsi),c.Chat.setState("bump",e.bu),c.Chat.setState("bumpMessage",e.bm),c.Chat.setState("placementTypeID",e.ptid),c.Chat.setState("p_color",e.p_color),c.Chat.setState("f_color",e.f_color),c.Chat.setState("customLogoPath",e.clp),c.Chat.setState("businessName",e.bn),c.Chat.setState("started",!1),c.Chat.setState("smsDisplay",e.mt),c.Chat.init(),"Desktop"==c.Chat.getState().pageType?c.Chat.recover():t(".cms-connect").append('<a href="sms:'+c.Chat.getPhoneFromCookie()+'" style="display:none" class="cms-connect-sms-click-text">clickToText</a>')}p>0&&(g=p),SessionId=t.cookie("_sa"),h=g>""?"https://sdrest.scorpiondesign.com/API/CX/v3/ChatPre?SAData="+m+"&dataLocation="+g:"https://sdrest.scorpiondesign.com/API/CX/v3/ChatPre?SAData="+m,t.ajax({url:h,dataType:"json",success:function(e){t.ajax({url:BaseUrl+"/CX/Chat/Pre?sdProjectId="+e.p,success:function(t){var e;t.length>0&&t[0].hasOwnProperty(["pcp"])&&(e=!(t[0].pcp.length>0)||function(t){var e=!1;pageData=t.pcp;for(var a=pageData.sort(function(t,e){return t.pr-e.pr}),n=0;n<a.length;n++){var s=a[n].rt.toLowerCase();if("exact"==s){if(document.location.pathname==a[n].rv){e=!0;break}}else if("wildcard"==s){var i=new RegExp(a[n].rv.replace(/\*/g,"[^ ]*"));document.location.pathname.match(i)&&(e=!0)}}return e}(t[0])),e&&function(t){for(var e=0;e<t.length;e++){var a=t[e];a.s&&a.e?(n=a.s,s=a.e,i=void 0,o=void 0,i=v(n),o=v(s),utcNow=v(new Date),utcNow>i&&utcNow<o&&u(a)):u(a)}var n,s,i,o}(t)}})}})}window.register&&window.register("cms/chat")}function C(t,e){t.getChannelByUniqueName(e).then(function(t){IPM_Channel=t,A(t,Transferred||null),c.Chat.setState("started",!0)}).then(function(){Transferred=void 0})}function f(t){return t==c.Chat.getState().Identity?"Guest":"Agent"}function A(t,e){e||(t.on("messageAdded",function(t){r.printMessage(t.body,f(t.author))}),t.on("typingStarted",function(){r.updateTypingIndicator(!0)}),t.on("typingEnded",function(){r.updateTypingIndicator(!1)})),t.on("memberLeft",function(){r.destroy(!1)}),t.getMessages(50).then(function(t){for(var e=0;e<t.items.length;e++){var a=t.items[e];void 0!==a.author&&r.printMessage(a.body,f(a.author))}}).then(function(){if(IPM_QueueMessages.length>0){for(var t=0;t<IPM_QueueMessages.length;t++)r.send(IPM_QueueMessages[t]);IPM_QueueMessages=[]}}).then(function(){r.loadingBubbles(!1)}).catch(function(t){console.log("An error while getting the message history",t)})}function v(t){var e;return e=t.getTime()+6e4*t.getTimezoneOffset(),e-=18e6}});